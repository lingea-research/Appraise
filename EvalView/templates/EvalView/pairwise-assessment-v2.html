{% extends "Dashboard/base.html" %}
{% load static %}

{% block head %}
<style>
.quotelike {
  border-left: 5px solid #eee;
  font-size: 16px;
  margin: 0 0 20px;
  padding: 10px 20px;
}
.quotelike-author { color: #777; font-size: 80%; line-height: 1.4; }
.quotelike-author:before { content: '\2014 \00A0'; }
.context-sentences p { color: #555; margin-bottom: 10px; line-height: 1.3; }
.priming-question { font-size: 130%; margin-bottom: 20px; }
.candidate-text.active .diff { background: #ff06; }

[data-pseudo-content]::before,
[data-pseudo-content--before]::before,
[data-pseudo-content--after]::after {
  content: attr(data-pseudo-content);
  font-weight:bold;
}

.question-box { margin-bottom:10px; }
.question-box p { font-size: 120%; margin: 10px 0 20px; font-style: italic; color: #31708f; }
.question-box li { font-size: 100%; font-style: italic; color: #31708f; }

.quality-scale {
  margin-top: 10px;
  width: 100%;
}
.quality-scale .btn-group {
  float: none;
}
.btn-quality {
  border: 0;
  border-radius: 0;
  margin: 0;
  padding: 14px 8px;
  color: #fff;
  font-weight: 600;
  white-space: normal;
  text-shadow: none;
  position: relative;
}
.btn-quality .quality-check {
  position: absolute;
  top: 8px;
  right: 8px;
  display: none;
  font-size: 1.2em;
  line-height: 1;
  color: #fff;
  text-shadow: 0 0 4px rgba(0, 0, 0, 0.45);
}
.btn-quality .quality-label {
  display: block;
  text-align: center;
}
.btn-quality .quality-grade {
  display: block;
  font-size: 1.4em;
  line-height: 1.2;
}
.btn-quality .quality-description {
  display: block;
  font-size: 0.85em;
  font-weight: 400;
  margin-top: 0.4em;
}
.btn-quality input {
  position: absolute;
  opacity: 0;
  pointer-events: none;
}
.btn-quality:focus,
.btn-quality:focus-within {
  outline: 2px solid #004085;
  outline-offset: 2px;
}
.btn-quality.active,
.btn-quality:hover {
  box-shadow: inset 0 0 0 2px rgba(255, 255, 255, 0.7);
  filter: brightness(1.1);
}
.btn-quality.active {
  transform: scale(1.03);
  box-shadow: inset 0 0 0 5px rgba(255, 255, 255, 0.85);
  filter: brightness(1.1);
}
.btn-quality.active .quality-check {
  display: block;
}
.quality-option-1 { background: #d9534f; }
.quality-option-2 {
  background: #f0ad4e; 
  color: #2f3b11;
}
.quality-option-3 {
  background: #d3e762;
  color: #2f3b11;
}
.quality-option-4 {
  background: #8edc8d;
  color: #14351a;
}
.quality-option-5 { background: #2e7d32; }
.quality-option-2 .quality-check,
.quality-option-3 .quality-check,
.quality-option-4 .quality-check {
  color: #2f3b11;
  text-shadow: 0 0 4px rgba(255, 255, 255, 0.6);
}
.quality-option-3 .quality-description,
.quality-option-4 .quality-description {
  color: inherit;
}
.quality-option-3 .quality-grade,
.quality-option-4 .quality-grade {
  color: inherit;
}
@media (max-width: 480px) {
  .quality-scale.btn-group-justified {
    display: block;
  }
  .quality-scale.btn-group-justified > .btn-group {
    display: block;
    float: none;
    width: 100%;
  }
  .quality-scale.btn-group-justified > .btn-group + .btn-group {
    margin-top: 10px;
  }
}
</style>

<script src="{% static 'EvalView/js/js.cookie-2.2.1.min.js' %}"></script>
<script>
<!--
$(document).ready(function() {
  $('input[name="start_timestamp"]').val(Date.now()/1000.0);

  var hiddenScore = $('input[name="score"]');
  if (hiddenScore.length) {
    hiddenScore.val(-1);
  }
  var hiddenScore2 = $('input[name="score2"]');
  if (hiddenScore2.length) {
    hiddenScore2.val(-1);
  }

  var qualityRadios = $('.quality-scale input[type="radio"]');
  qualityRadios.on('change', function() {
    var selectedScore = Number($(this).data('score'));
    if (isNaN(selectedScore)) {
      selectedScore = Number($(this).val());
    }
    var container = $(this).closest('.quality-scale');
    set_hidden_score(container, selectedScore);
    update_active_state(container, $(this));
  });

  $('.quality-scale').each(function() {
    var container = $(this);
    var hiddenInput = get_hidden_input(container);
    if (!hiddenInput.length) {
      return;
    }
    var existingScore = Number(hiddenInput.val());
    if (!isNaN(existingScore) && existingScore >= 0) {
      set_selected_score(container.attr('id'), existingScore, false);
    }
  });

  if (qualityRadios.length) {
    qualityRadios.first().focus();
  }

  if (Cookies.get('show-context') == 'yes') {
    $('.context-sentences').show();
    $('#reference-label').hide();
  }

  if (Cookies.get('show-diff') != 'no') {
    $('.candidate-text').addClass('active');
  }

  // Show guidelines in a popup box
  $('#guidelines-modal').modal('show');
});

function get_hidden_input(container) {
  var targetName = container.data('target-input');
  if (!targetName) {
    return $();
  }
  return $('input[name="' + targetName + '"]');
}

function set_hidden_score(container, score) {
  var hiddenInput = get_hidden_input(container);
  if (!hiddenInput.length) {
    return;
  }
  hiddenInput.val(score);
}

function update_active_state(container, radioInput) {
  var buttons = container.find('.btn-quality');
  buttons.removeClass('active');
  if (radioInput && radioInput.length) {
    radioInput.closest('.btn-quality').addClass('active');
  }
}

function set_selected_score(containerId, score, triggerChange) {
  var container = $('#' + containerId);
  if (!container.length) {
    return;
  }
  var radios = container.find('input[type="radio"]');
  var target = radios.filter(function() {
    return Number($(this).data('score')) === Number(score);
  }).first();
  if (!target.length) {
    return;
  }
  radios.prop('checked', false);
  target.prop('checked', true);
  update_active_state(container, target);
  if (triggerChange !== false) {
    target.trigger('change');
  } else {
    set_hidden_score(container, Number(score));
  }
}

function get_selected_score(containerId) {
  var container = $('#' + containerId);
  if (!container.length) {
    return null;
  }
  var checked = container.find('input[type="radio"]:checked');
  if (!checked.length) {
    return null;
  }
  return Number(checked.data('score'));
}

function toggle_context()
{
    var isHidden = $('.context-sentences').first().is(':hidden') ? 'yes' : 'no';
    $('.context-sentences').toggle(200);
    $('#reference-label').toggle();
    Cookies.set('show-context', isHidden, { sameSite: 'strict' });
}

function toggle_diff()
{
    var isActive = $('.candidate-text').first().hasClass('active');
    if (isActive) {
        $('.candidate-text').removeClass('active');
    } else {
        $('.candidate-text').addClass('active');
    }
    Cookies.set('show-diff', isActive ? 'no' : 'yes', { sameSite: 'strict' });
}

function add_end_timestamp()
{
  $('input[name="end_timestamp"]').val(Date.now()/1000.0);
}

function reset_form()
{
  $('input[name="start_timestamp"]').val(Date.now()/1000.0);
  $('.quality-scale input[type="radio"]').prop('checked', false);
  $('.quality-scale .btn-quality').removeClass('active');
  $('input[name="score"]').val(-1);
  $('input[name="score2"]').val(-1);
  $('input[name="error1"]').prop("checked", false);
  $('input[name="error2"]').prop("checked", false);
}

function validate_form()
{
  var score1 = $('input[name="score"]');
  var score2 = $('input[name="score2"]');
  if (score1.val() == -1 || (score2.length && score2.val() == -1))
  {
    alert('Please score all candidate sentences. Thanks!');
    return false;
  }

  return true;
}

function match_ratings()
{
  var score1 = get_selected_score('rating');
  if (score1 === null) {
    return;
  }
  set_selected_score('rating2', score1);
}
-->
</script>

{% endblock %}

{% block content %}

<form action="{{action_url}}" method="post" onsubmit="javascript:add_end_timestamp();">
{% csrf_token %}

<div class="alert">
  <table style="width:100%">
  <tr>
    <td style="width:33%;text-align:left;">
      <strong id="task_progress">{% if trusted_user %}<span class="glyphicon glyphicon-ok-sign" aria-hidden="true"></span> {% endif %}{{completed_blocks}}/10 blocks, {{items_left_in_block}} items left in block</strong>
    </td>
    <td style="width:33%;text-align:center;">
      <strong>{{campaign}} #{{datask_id}}:Segment #{{item_id}}</strong>
    </td>
    <td style="width:33%;text-align:right;">
      <strong>{% if source_language %}{{source_language}} &rarr; {% endif %}{{target_language}}</strong>
    </td>
  </tr>
  </table>
</div>

<div class="row quotelike">
<div class="col-sm-12">
    <div class="context-sentences" style="display: none">
    {% if context_left %}
        <p><small>{{context_left|safe}}</small></p>
    {% endif %}
    </div>

    <p><strong>{{reference_text|safe}}</strong></p>
    <p class="quotelike-author" id="reference-label">{{reference_label}}</p>

    <div class="context-sentences" style="display: none">
    {% if context_right %}
        <p><small>{{context_right|safe}}</small></p>
    {% endif %}
    </div>
</div>
</div>

<div class="row question-box">
    <div class="col-sm-12">
        <p class="priming-question">{{priming_question_text|safe}}</p>
    </div>
</div>

<input name="end_timestamp" type="hidden" value="" />
<input name="item_id" type="hidden" value="{{item_id}}" />
<input name="task_id" type="hidden" value="{{task_id}}" />
<input name="start_timestamp" type="hidden" value="" />
<input name="score" type="hidden" value="-1" />
{% if candidate2_text %}
<input name="score2" type="hidden" value="-1" />
{% endif %}

<div class="row quotelike">
    <div class="col-sm-12">
        <p class="candidate-text"><strong>{{candidate_text|safe}}</strong></p>
    </div>

    {% with sliderid='' %}
    {% include 'EvalView/_quality_slider.html' %}
    {% endwith %}
</div>

{% if candidate2_text %}

<div class="row quotelike">
    <div class="col-sm-12">
        <p class="candidate-text"><strong>{{candidate2_text|safe}}</strong></p>
    </div>
    {% with sliderid='2' %}
    {% include 'EvalView/_quality_slider.html' %}
    {% endwith %}

</div>
{% endif %}

<div class="actions">
  <table style="width:100%">
  <tr>
    <td style="width:50%;text-align:left;">
      <button onclick="javascript:reset_form();" accesskey="2" type="reset" class="btn"
        title="Reset the rating buttons. Access key: '2'"><i class="icon-repeat"></i> Reset</button>

      {% if candidate2_text %}
      <button onclick="javascript:toggle_diff();" accesskey="4" type="button" class="btn"
              title="Show or hide highlighted differences between segments. Access key: '4'">Show/Hide diff.</button>
      {% endif %}
      {% if context_left or context_right %}
      <button onclick="javascript:toggle_context();" accesskey="5" type="button" class="btn"
              title="Show or hide the context. Access key: '5'">Show/Hide context</button>
      {% endif %}
    </td>
    <td style="width:50%;text-align:right;">
      {% if candidate2_text %}
      <button onclick="javascript:match_ratings();" accesskey="3" type="button" class="btn"
        title="Match the second rating with the first one. Access key: '3'">Match ratings</button>
      {% endif %}
      <button class="btn btn-primary" name="submit_button" accesskey="1" type="submit" value="SUBMIT" onclick="javascript:return validate_form();"
              title="Submit score(s). Access key: '1'"><i class="icon-ok-sign icon-white"></i> Submit</button>
    </td>
  </tr>
  </table>
</div>

</form>

{% endblock %}
