{% extends "Dashboard/base.html" %}
{% load static %}

{% block head %}
<style>
.assessment-shell {
  border: 1px solid #e3e6eb;
  border-radius: 16px;
  padding: 32px;
  background: #ffffff;
  box-shadow: 0 20px 45px rgba(15, 23, 42, 0.08);
  transition: box-shadow 0.2s ease;
  margin: 0 auto;
  max-width: 1100px;
  width: 100%;
}
.assessment-shell:hover {
  box-shadow: 0 24px 55px rgba(15, 23, 42, 0.12);
}
.container.container-wide {
  width: 100% !important;
  max-width: none;
  padding-left: 24px;
  padding-right: 24px;
}
.container.container-wide .assessment-shell {
  max-width: none;
}
.assessment-header {
  margin-bottom: 24px;
}
.assessment-header strong {
  font-weight: 600;
}
.assessment-header .text-muted {
  text-transform: uppercase;
  letter-spacing: 0.08em;
  font-size: 0.75rem;
  color: #9aa5b1 !important;
}
.quotelike-author {
  color: #6c757d;
  font-size: 0.9rem;
  letter-spacing: 0.04em;
  text-transform: uppercase;
  margin-bottom: 0;
}
.quotelike-author:before {
  content: '\2014\00A0';
}
.context-sentences p {
  color: #6c757d;
  margin-bottom: 6px;
  font-style: italic;
}
.candidate-text.active .diff {
  background: #fff3cd;
  border-radius: 4px;
  padding: 0 4px;
}
.layout-controls {
  display: inline-block;
  margin-bottom: 15px;
  gap: 10px;
  flex-wrap: wrap;
}
.layout-controls[data-layout-group="width"] {
  justify-content: flex-end;
  margin-top: -6px;
  margin-bottom: 22px;
}
.layout-button {
  border: none;
  border-radius: 999px;
  padding: 8px 14px;
  display: inline-flex;
  align-items: center;
  gap: 6px;
  background: #f5f7fa;
  color: #495057;
  font-weight: 600;
  letter-spacing: 0.04em;
  text-transform: uppercase;
  transition: background 0.2s ease, color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
}
.layout-button:hover,
.layout-button:focus {
  color: #212529;
  text-decoration: none;
  transform: translateY(-1px);
}
.layout-button.active {
  background: #337ab7;
  color: #ffffff;
}
.layout-button .glyphicon {
  font-size: 1rem;
}
.layout-button .layout-label {
  font-size: 0.75rem;
}
.reference-panel {
  position: relative;
  border: 1px solid #e3e6eb;
  border-radius: 12px;
  padding: 52px 28px 28px;
  margin: 20px 0 24px;
}
.reference-panel::before {
  content: attr(data-reference-label);
  position: absolute;
  top: 20px;
  left: 28px;
  font-weight: 700;
  font-size: 0.85rem;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  color: #5c6ac4;
}
.reference-panel p {
  margin-top: 0;
  margin-bottom: 12px;
  color: #212529;
}
#reference-label {
  position: absolute;
  width: 1px;
  height: 1px;
  padding: 0;
  margin: -1px;
  overflow: hidden;
  clip: rect(0, 0, 0, 0);
  clip-path: inset(50%);
  border: 0;
}
#reference-label:before {
  display: none;
}
.reference-panel[data-reference-label=""]::before {
  display: none;
}
[data-orientation="vertical"] .candidate-wrapper {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 20px;
}
[data-orientation="stacked"] .candidate-wrapper {
  display: grid;
  grid-template-columns: 1fr;
  gap: 20px;
}
[data-orientation="stacked"] .candidate-wrapper {
  margin-top: 12px;
}
.candidate-card {
  position: relative;
  border: 1px solid #e3e6eb;
  border-radius: 12px;
  padding: 52px 28px 28px;
  transition: border-color 0.15s ease, box-shadow 0.15s ease;
}
.candidate-card::before {
  content: attr(data-pseudo-content);
  position: absolute;
  top: 20px;
  left: 28px;
  font-weight: 700;
  font-size: 0.85rem;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  color: #6c757d;
}
.candidate-card:hover {
  border-color: #d0d7de;
  box-shadow: 0 12px 30px rgba(15, 23, 42, 0.08);
}
.candidate-card .candidate-text {
  padding-left: 0;
}
.candidate-card .rating-row {
  padding-left: 0;
}
.candidate-text strong {
  font-weight: 600;
  color: #212529;
}
.rating-row {
  margin-top: 16px;
}
.question-box {
  margin-bottom: 24px;
  font-size: 1.05rem;
  color: #495057;
}
.question-box .priming-question {
  font-size: 1.25rem;
  margin: 0;
  font-weight: 500;
  color: #212529;
}
.quality-scale {
  margin-top: 4px;
  width: 100%;
}
.quality-scale .btn-group {
  float: none;
}
.btn-quality {
  border: 0;
  border-radius: 0;
  margin: 0;
  color: #fff;
  white-space: normal;
  text-shadow: none;
  position: relative;
}
.btn-quality .quality-check {
  position: absolute;
  top: 8px;
  right: 8px;
  display: none;
  font-size: 1.2em;
  line-height: 1;
  color: #fff;
  text-shadow: 0 0 4px rgba(0, 0, 0, 0.45);
}
.btn-quality .quality-label {
  display: block;
  text-align: center;
}
.btn-quality .quality-grade {
  display: block;
  font-size: 1.4em;
  line-height: 1.2;
}
.btn-quality .quality-description {
  display: block;
  font-size: 0.85em;
  font-weight: 400;
  margin-top: 0.4em;
}
.btn-quality input {
  position: absolute;
  opacity: 0;
  pointer-events: none;
}
.btn-quality:focus,
.btn-quality:focus-within {
  outline: 2px solid #004085;
  outline-offset: 2px;
}
.btn-quality.active,
.btn-quality:hover {
  box-shadow: inset 0 0 0 2px rgba(255, 255, 255, 0.7);
  filter: brightness(1.1);
}
.btn-quality.active {
  transform: scale(1.03);
  box-shadow: inset 0 0 0 5px rgba(255, 255, 255, 0.85);
  filter: brightness(1.1);
}
.btn-quality.active .quality-check {
  display: block;
}
.quality-option-1 { background: #d9534f; }
.quality-option-2 {
  background: #f0ad4e;
  color: #2f3b11;
}
.quality-option-3 {
  background: #d3e762;
  color: #2f3b11;
}
.quality-option-4 {
  background: #8edc8d;
  color: #14351a;
}
.quality-option-5 { background: #2e7d32; }
.quality-option-2 .quality-check,
.quality-option-3 .quality-check,
.quality-option-4 .quality-check {
  color: #2f3b11;
  text-shadow: 0 0 4px rgba(255, 255, 255, 0.6);
}
.quality-option-3 .quality-description,
.quality-option-4 .quality-description {
  color: inherit;
}
.quality-option-3 .quality-grade,
.quality-option-4 .quality-grade {
  color: inherit;
}
.actions {
  margin-top: 24px;
}
.actions .btn {
  border-radius: 999px;
  padding: 10px 22px;
}
.actions table {
  width: 100%;
}
@media (max-width: 992px) {
  .assessment-shell {
    padding: 24px;
  }
  .reference-panel,
  .candidate-card {
    padding: 24px 12px 12px;
  }
  .reference-panel::before,
  .candidate-card::before {
    left: 24px;
  }
}
@media (max-width: 768px) {
  .assessment-shell {
    padding: 20px;
  }
  .layout-controls {
    justify-content: center;
  }
  .layout-controls[data-layout-group="width"] {
    justify-content: center;
    margin-top: 0;
  }
  .layout-button {
    flex: 1 1 48%;
    justify-content: center;
  }
  .reference-panel,
  .candidate-card {
    padding: 44px 20px 20px;
  }
  .reference-panel::before,
  .candidate-card::before {
    left: 20px;
  }
  .assessment-header .text-right,
  .assessment-header .text-center {
    text-align: left !important;
    margin-top: 12px;
  }
}
@media (max-width: 480px) {
  .quality-scale.btn-group-justified {
    display: block;
  }
  .quality-scale.btn-group-justified > .btn-group {
    display: block;
    float: none;
    width: 100%;
  }
  .quality-scale.btn-group-justified > .btn-group + .btn-group {
    margin-top: 10px;
  }
}
</style>

<script src="{% static 'EvalView/js/js.cookie-2.2.1.min.js' %}"></script>
<script src="{% static 'EvalView/js/pairwise-assessment-v2.js' %}"></script>
<script>
function get_hidden_input(container) {
  var targetName = container.data('target-input');
  if (!targetName) {
    return $();
  }
  return $('input[name="' + targetName + '"]');
}

function set_hidden_score(container, score) {
  var hiddenInput = get_hidden_input(container);
  if (!hiddenInput.length) {
    return;
  }
  hiddenInput.val(score);
}

function update_active_state(container, radioInput) {
  var buttons = container.find('.btn-quality');
  buttons.removeClass('active');
  if (radioInput && radioInput.length) {
    radioInput.closest('.btn-quality').addClass('active');
  }
}

function set_selected_score(containerId, score, triggerChange) {
  var container = $('#' + containerId);
  if (!container.length) {
    return;
  }
  var radios = container.find('input[type="radio"]');
  var target = radios.filter(function() {
    return Number($(this).data('score')) === Number(score);
  }).first();
  if (!target.length) {
    return;
  }
  radios.prop('checked', false);
  target.prop('checked', true);
  update_active_state(container, target);
  if (triggerChange !== false) {
    target.trigger('change');
  } else {
    set_hidden_score(container, Number(score));
  }
}

function get_selected_score(containerId) {
  var container = $('#' + containerId);
  if (!container.length) {
    return null;
  }
  var checked = container.find('input[type="radio"]:checked');
  if (!checked.length) {
    return null;
  }
  return Number(checked.data('score'));
}

function toggle_context()
{
  var contextBlocks = $('.context-sentences');
  if (!contextBlocks.length) {
    return;
  }
  var referencePanel = $('.reference-panel').first();
  var referenceLabel = $('#reference-label').text();
  var wasHidden = contextBlocks.first().is(':hidden');
  contextBlocks.toggle(200);
  if (referencePanel.length) {
    referencePanel.attr('data-reference-label', wasHidden ? '' : referenceLabel);
  }
  Cookies.set('show-context', wasHidden ? 'yes' : 'no', { sameSite: 'strict' });
}

function toggle_diff()
{
    var isActive = $('.candidate-text').first().hasClass('active');
    if (isActive) {
        $('.candidate-text').removeClass('active');
    } else {
        $('.candidate-text').addClass('active');
    }
    Cookies.set('show-diff', isActive ? 'no' : 'yes', { sameSite: 'strict' });
}

function add_end_timestamp()
{
  $('input[name="end_timestamp"]').val(Date.now()/1000.0);
}

function reset_form()
{
  $('input[name="start_timestamp"]').val(Date.now()/1000.0);
  $('.quality-scale input[type="radio"]').prop('checked', false);
  $('.quality-scale .btn-quality').removeClass('active');
  $('input[name="score"]').val(-1);
  $('input[name="score2"]').val(-1);
  $('input[name="error1"]').prop("checked", false);
  $('input[name="error2"]').prop("checked", false);
}

function validate_form()
{
  var score1 = $('input[name="score"]');
  var score2 = $('input[name="score2"]');
  if (score1.val() == -1 || (score2.length && score2.val() == -1))
  {
    alert('Please score all candidate sentences. Thanks!');
    return false;
  }

  return true;
}

function match_ratings()
{
  var score1 = get_selected_score('rating');
  if (score1 === null) {
    return;
  }
  set_selected_score('rating2', score1);
}

$(document).ready(function() {
  $('input[name="start_timestamp"]').val(Date.now()/1000.0);

  var hiddenScore = $('input[name="score"]');
  if (hiddenScore.length) {
    hiddenScore.val(-1);
  }
  var hiddenScore2 = $('input[name="score2"]');
  if (hiddenScore2.length) {
    hiddenScore2.val(-1);
  }

  var qualityRadios = $('.quality-scale input[type="radio"]');
  qualityRadios.on('change', function() {
    var selectedScore = Number($(this).data('score'));
    if (isNaN(selectedScore)) {
      selectedScore = Number($(this).val());
    }
    var container = $(this).closest('.quality-scale');
    set_hidden_score(container, selectedScore);
    update_active_state(container, $(this));
  });

  $('.quality-scale').each(function() {
    var container = $(this);
    var hiddenInput = get_hidden_input(container);
    if (!hiddenInput.length) {
      return;
    }
    var existingScore = Number(hiddenInput.val());
    if (!isNaN(existingScore) && existingScore >= 0) {
      set_selected_score(container.attr('id'), existingScore, false);
    }
  });

  if (qualityRadios.length) {
    qualityRadios.first().focus();
  }

  var referencePanel = $('.reference-panel').first();
  var referenceLabel = $('#reference-label').text();
  if (referencePanel.length && !referencePanel.attr('data-reference-label')) {
    referencePanel.attr('data-reference-label', referenceLabel);
  }

  if (Cookies.get('show-context') == 'yes') {
    $('.context-sentences').show();
    if (referencePanel.length) {
      referencePanel.attr('data-reference-label', '');
    }
  } else if (referencePanel.length) {
    referencePanel.attr('data-reference-label', referenceLabel);
  }

  if (Cookies.get('show-diff') != 'no') {
    $('.candidate-text').addClass('active');
  }

  $('#guidelines-modal').modal('show');
});
</script>

{% endblock %}

{% block content %}

<div class="layout-controls" role="group" aria-label="Assessment layout options">
  <button type="button" class="layout-button" data-orientation-choice="vertical" aria-pressed="false">
    <span class="glyphicon glyphicon-option-vertical" aria-hidden="true"></span>
    <span class="layout-label">Vertical</span>
  </button>
  <button type="button" class="layout-button" data-orientation-choice="stacked" aria-pressed="false">
    <span class="glyphicon glyphicon-menu-hamburger" aria-hidden="true"></span>
    <span class="layout-label">Stacked</span>
  </button>
</div>

<div class="layout-controls" data-layout-group="width" role="group" aria-label="Assessment width options">
  <button type="button" class="layout-button" data-width-choice="narrow" aria-pressed="false">
    <span class="glyphicon glyphicon-resize-small" aria-hidden="true"></span>
    <span class="layout-label">Narrow</span>
  </button>
  <button type="button" class="layout-button" data-width-choice="wide" aria-pressed="false">
    <span class="glyphicon glyphicon-resize-full" aria-hidden="true"></span>
    <span class="layout-label">Wide</span>
  </button>
</div>

<div class="assessment-shell" data-layout-container data-orientation="vertical">

<form action="{{action_url}}" method="post" onsubmit="javascript:add_end_timestamp();" data-assessment-form data-orientation="vertical">
{% csrf_token %}

<div class="assessment-header">
  <div class="row">
    <div class="col-sm-4 col-xs-12">
      <span class="text-muted">{{campaign}}:{{datask_id}}:{{item_id}}</span><br>
      <strong id="task_progress">{% if trusted_user %}<span class="glyphicon glyphicon-ok-sign" aria-hidden="true"></span> {% endif %}Item {{num_items_done}}/{{num_items_total}}</strong>
    </div>
    <div class="col-sm-4 col-xs-12 text-center">
    </div>
    <div class="col-sm-4 col-xs-12 text-right">
      <span class="text-muted">Language pair</span><br>
      <strong>{% if source_language %}{{source_language}} &rarr; {% endif %}{{target_language}}</strong>
    </div>
  </div>
</div>

<div class="question-box">
  <p class="priming-question">
    How accurately does each of the candidate text(s) below convey the original semantics of the source text?
  <p>
</div>

<div class="reference-panel" data-reference-label="{{reference_label}}">
  <div class="context-sentences" style="display: none">
    {% if context_left %}
      <p><small>{{context_left|safe}}</small></p>
    {% endif %}
  </div>

  <p><strong>{{reference_text|safe}}</strong></p>
  <p class="quotelike-author" id="reference-label">{{reference_label}}</p>

  <div class="context-sentences" style="display: none">
    {% if context_right %}
      <p><small>{{context_right|safe}}</small></p>
    {% endif %}
  </div>
</div>

<input name="end_timestamp" type="hidden" value="" />
<input name="item_id" type="hidden" value="{{item_id}}" />
<input name="task_id" type="hidden" value="{{task_id}}" />
<input name="start_timestamp" type="hidden" value="" />
<input name="score" type="hidden" value="-1" />
{% if candidate2_text %}
<input name="score2" type="hidden" value="-1" />
{% endif %}

<div class="candidate-wrapper">
  <div class="candidate-card" data-pseudo-content="Candidate A">
    <p class="candidate-text"><strong>{{candidate_text|safe}}</strong></p>
    <div class="rating-row">
      {% with sliderid='' %}
      {% include 'EvalView/_quality_slider.html' %}
      {% endwith %}
    </div>
  </div>

  {% if candidate2_text %}
  <div class="candidate-card" data-pseudo-content="Candidate B">
    <p class="candidate-text"><strong>{{candidate2_text|safe}}</strong></p>
    <div class="rating-row">
      {% with sliderid='2' %}
      {% include 'EvalView/_quality_slider.html' %}
      {% endwith %}
    </div>
  </div>
  {% endif %}
</div>

<div class="actions">
  <table style="width:100%">
  <tr>
    <td style="width:50%;text-align:left;">
      <button onclick="javascript:reset_form();" accesskey="2" type="reset" class="btn btn-default"
        title="Reset the rating buttons. Access key: '2'"><i class="icon-repeat"></i> Reset</button>

      {% if candidate2_text %}
      <button onclick="javascript:toggle_diff();" accesskey="4" type="button" class="btn btn-default"
              title="Show or hide highlighted differences between segments. Access key: '4'">Show/Hide diff.</button>
      {% endif %}
      {% if context_left or context_right %}
      <button onclick="javascript:toggle_context();" accesskey="5" type="button" class="btn btn-default"
              title="Show or hide the context. Access key: '5'">Show/Hide context</button>
      {% endif %}
    </td>
    <td style="width:50%;text-align:right;">
      {% if candidate2_text %}
      <button onclick="javascript:match_ratings();" accesskey="3" type="button" class="btn btn-default"
        title="Match the second rating with the first one. Access key: '3'">Match ratings</button>
      {% endif %}
      <button class="btn btn-primary" name="submit_button" accesskey="1" type="submit" value="SUBMIT" onclick="javascript:return validate_form();"
              title="Submit score(s). Access key: '1'"><i class="icon-ok-sign icon-white"></i> Submit</button>
    </td>
  </tr>
  </table>
</div>

</form>

</div>

{% endblock %}
