{% extends "Dashboard/base.html" %}
{% load static %}

{% block head %}
<style>
.slider { margin-top: 10px; }

.quotelike {
  border-left: 5px solid #eee;
  font-size: 16px;
  margin: 0 0 20px;
  padding: 10px 20px;
}
.quotelike-author { color: #777; font-size: 80%; line-height: 1.4; }
.quotelike-author:before { content: '\2014 \00A0'; }
.context-sentences p { color: #555; margin-bottom: 10px; line-height: 1.3; }
.priming-question { font-size: 130%; margin-bottom: 20px; }
.candidate-text.active .diff { background: #ff06; }

small.padleft { padding-left: 20px; }
small.padright { padding-right: 20px; }

[data-pseudo-content]::before,
[data-pseudo-content--before]::before,
[data-pseudo-content--after]::after {
  content: attr(data-pseudo-content);
  font-weight:bold;
}

.button-critical-error { margin-top:10px; }

.question-box { margin-bottom:10px; }
.question-box p { font-size: 120%; margin: 10px 0 20px; font-style: italic; color: #31708f; }
.question-box li { font-size: 100%; font-style: italic; color: #31708f; }
</style>

<link rel="stylesheet" href="{% static 'EvalView/css/jquery-ui.css' %}">
<link rel="stylesheet" href="{% static 'EvalView/css/scalar-slider.css' %}">
<script src="{% static 'EvalView/js/jquery-ui.min.js' %}"></script>
<script src="{% static 'EvalView/js/js.cookie-2.2.1.min.js' %}"></script>
<script>
<!--
String.prototype.rot13 = function() {
  return this.replace(/[a-zA-Z]/g, function(c) {
    return String.fromCharCode((c <= "Z" ? 90 : 122) >= (c = c.charCodeAt(0) + 13) ? c : c - 26);
  });
};

var scalarSliderEnabled = {{ scalar_slider|yesno:"true,false" }};
var scalarSliderValueCount = 10;
var scalarSliderMin = 0;
var scalarSliderMax = 100;
var scalarSliderStep = scalarSliderValueCount > 1 ? (scalarSliderMax - scalarSliderMin) / (scalarSliderValueCount - 1) : 0;
if (scalarSliderEnabled) {
  scalarSliderStep = parseFloat(scalarSliderStep.toFixed(6));
}
var scalarSliderValues = [];
var qualityClasses = [
  'quality-option-1',
  'quality-option-2',
  'quality-option-3',
  'quality-option-4',
  'quality-option-5',
  'quality-option-6',
  'quality-option-7',
  'quality-option-8',
  'quality-option-9',
  'quality-option-10'
];
var sliderUnsetClass = 'quality-option-unset';

if (scalarSliderEnabled) {
  for (var scalarIndex = 0; scalarIndex < scalarSliderValueCount; scalarIndex += 1) {
    var scalarValue = scalarSliderMin + scalarSliderStep * scalarIndex;
    if (scalarIndex === scalarSliderValueCount - 1) {
      scalarValue = scalarSliderMax;
    }
    scalarSliderValues.push(parseFloat(scalarValue.toFixed(4)));
  }
}

function snapScalarValue(value)
{
  if (!scalarSliderEnabled || scalarSliderValues.length === 0) {
    return value;
  }

  var closest = scalarSliderValues[0];
  for (var i = 1; i < scalarSliderValues.length; i += 1) {
    if (Math.abs(value - scalarSliderValues[i]) < Math.abs(value - closest)) {
      closest = scalarSliderValues[i];
    }
  }
  return closest;
}

function formatScalarValue(value)
{
  var numericValue = parseFloat(value);
  if (isNaN(numericValue)) {
    return value;
  }

  if (!scalarSliderEnabled) {
    return numericValue;
  }

  var snapped = snapScalarValue(numericValue);
  return parseFloat(snapped.toFixed(4));
}

function getQualityClass(value)
{
  if (!scalarSliderEnabled || scalarSliderValues.length === 0) {
    return null;
  }

  var numericValue = parseFloat(value);
  if (isNaN(numericValue)) {
    return null;
  }

  var closestIndex = 0;
  var smallestDiff = Math.abs(numericValue - scalarSliderValues[0]);
  for (var i = 1; i < scalarSliderValues.length; i += 1) {
    var diff = Math.abs(numericValue - scalarSliderValues[i]);
    if (diff < smallestDiff) {
      smallestDiff = diff;
      closestIndex = i;
    }
  }

  if (closestIndex >= qualityClasses.length) {
    closestIndex = qualityClasses.length - 1;
  }

  return qualityClasses[closestIndex];
}

function applySliderQualityClass(sliderElement, value)
{
  if (!sliderElement || sliderElement.length === 0 || !scalarSliderEnabled) {
    return;
  }

  var range = sliderElement.find('.ui-slider-range');
  var handle = sliderElement.find('.ui-slider-handle');
  var touched = sliderElement.data('slider-touched');
  var classList = qualityClasses.slice();
  classList.push(sliderUnsetClass);

  range.removeClass(classList.join(' '));
  handle.removeClass(classList.join(' '));

  if (!touched) {
    range.addClass(sliderUnsetClass);
    handle.addClass(sliderUnsetClass);
    return;
  }

  var qualityClass = getQualityClass(value);
  if (qualityClass) {
    range.addClass(qualityClass);
    handle.addClass(qualityClass);
  }
}

$(document).ready(function() {
  $('input[name="start_timestamp"]').val(Date.now()/1000.0);

  var sliderOptions = {orientation: "horizontal", range: "min", change: update_score, slide: update_score};
  if (scalarSliderEnabled) {
    sliderOptions.min = scalarSliderMin;
    sliderOptions.max = scalarSliderMax;
    sliderOptions.step = scalarSliderStep;
  }
  $('#slider').slider(sliderOptions);
  $('#slider').data('slider-touched', false);
  applySliderQualityClass($('#slider'), $('#slider').slider('value'));
  $('input[name="score"]').val(-1);

  if ($('#slider2').length) {
    var slider2Options = {orientation: "horizontal", range: "min", change: update_score2, slide: update_score2};
    if (scalarSliderEnabled) {
      slider2Options.min = scalarSliderMin;
      slider2Options.max = scalarSliderMax;
      slider2Options.step = scalarSliderStep;
    }
    $('#slider2').slider(slider2Options);
    $('#slider2').data('slider-touched', false);
    applySliderQualityClass($('#slider2'), $('#slider2').slider('value'));
  }
  $('input[name="score2"]').val(-1);

  if (Cookies.get('show-context') == 'yes') {
    $('.context-sentences').show();
    $('#reference-label').hide();
  }

  if (Cookies.get('show-diff') != 'no') {
    $('.candidate-text').addClass('active');
  }

  // make the first slider active, so that the score can be changed using left/right keys
  $('#slider .ui-slider-handle').focus();

  // Show guidelines in a popup box
  $('#guidelines-modal').modal('show');
});

function toggle_context()
{
    var isHidden = $('.context-sentences').first().is(':hidden') ? 'yes' : 'no';
    $('.context-sentences').toggle(200);
    $('#reference-label').toggle();
    Cookies.set('show-context', isHidden, { sameSite: 'strict' });
}

function toggle_diff()
{
    var isActive = $('.candidate-text').first().hasClass('active');
    if (isActive) {
        $('.candidate-text').removeClass('active');
    } else {
        $('.candidate-text').addClass('active');
    }
    Cookies.set('show-diff', isActive ? 'no' : 'yes', { sameSite: 'strict' });
}

function add_end_timestamp()
{
  $('input[name="end_timestamp"]').val(Date.now()/1000.0);
}

function reset_form()
{
  $('input[name="start_timestamp"]').val(Date.now()/1000.0);
  var resetValue = scalarSliderEnabled ? scalarSliderMin : 0;
  $('#slider').data('slider-touched', false);
  $('#slider').slider('option', 'value', resetValue);
  applySliderQualityClass($('#slider'), resetValue);
  if ($('#slider2').length) {
    $('#slider2').data('slider-touched', false);
    $('#slider2').slider('option', 'value', resetValue);
    applySliderQualityClass($('#slider2'), resetValue);
  }
  $('input[name="score"]').val(-1);
  $('input[name="score2"]').val(-1);
  $('input[name="error1"]').prop("checked", false);
  $('input[name="error2"]').prop("checked", false);
}

function validate_form()
{
  var score1 = $('input[name="score"]');
  var score2 = $('input[name="score2"]');
  if (score1.val() == -1 || (score2.length && score2.val() == -1))
  {
    alert('Please score all candidate sentences. Thanks!');
    return false;
  }

  return true;
}

function update_score(event, ui)
{
  var sliderElement = $('#slider');
  var sliderValue = (ui && ui.value !== undefined) ? ui.value : sliderElement.slider('value');
  var new_score = formatScalarValue(sliderValue);
  if (scalarSliderEnabled) {
    var currentValue = sliderElement.slider('value');
    if (Math.abs(currentValue - new_score) > 0.000001) {
      sliderElement.slider('option', 'value', new_score);
    }
  }
  var fromUser = event && event.originalEvent;
  if (fromUser) {
    sliderElement.data('slider-touched', true);
  }
  applySliderQualityClass(sliderElement, new_score);
  var storedValue = scalarSliderEnabled ? Math.round(new_score) : new_score;
  $('input[name="score"]').val(storedValue);
}

function update_score2(event, ui)
{
  if (!$('#slider2').length) {
    return;
  }
  var sliderElement = $('#slider2');
  var sliderValue = (ui && ui.value !== undefined) ? ui.value : sliderElement.slider('value');
  var new_score = formatScalarValue(sliderValue);
  if (scalarSliderEnabled) {
    var currentValue = sliderElement.slider('value');
    if (Math.abs(currentValue - new_score) > 0.000001) {
      sliderElement.slider('option', 'value', new_score);
    }
  }
  var fromUser = event && event.originalEvent;
  if (fromUser) {
    sliderElement.data('slider-touched', true);
  }
  applySliderQualityClass(sliderElement, new_score);
  var storedValue = scalarSliderEnabled ? Math.round(new_score) : new_score;
  $('input[name="score2"]').val(storedValue);
}

function match_sliders()
{
  if (!$('#slider2').length) {
    return;
  }
  var score1 = $('input[name="score"]').val();
  if (score1 == -1) {
    return;
  }
  var newValue = formatScalarValue(score1);
  $('#slider2').data('slider-touched', true);
  $('#slider2').slider('option', 'value', newValue);
  update_score2(null, {value: newValue});
}
-->
</script>

{% endblock %}

{% block content %}

<form action="{{action_url}}" method="post" onsubmit="javascript:add_end_timestamp();">
{% csrf_token %}

<div class="alert alert-info">
  <table style="width:100%">
  <tr>
    <td style="width:33%;text-align:left;">
      <strong id="task_progress">{% if trusted_user %}<span class="glyphicon glyphicon-ok-sign" aria-hidden="true"></span> {% endif %}{{completed_blocks}}/10 blocks, {{items_left_in_block}} items left in block</strong>
    </td>
    <td style="width:33%;text-align:center;">
      <strong>{{campaign}} #{{datask_id}}:Segment #{{item_id}}</strong>
    </td>
    <td style="width:33%;text-align:right;">
      <strong>{% if source_language %}{{source_language}} &rarr; {% endif %}{{target_language}}</strong>
    </td>
  </tr>
  </table>
</div>

{% if guidelines_popup %}
    {% include 'EvalView/_guidelines_popup.html' %}
{% endif %}

<div class="row quotelike">
<div class="col-sm-12">
    <div class="context-sentences" style="display: none">
    {% if context_left %}
        <p><small>{{context_left|safe}}</small></p>
    {% endif %}
    </div>

    <p><strong>{{reference_text|safe}}</strong></p>
    <p class="quotelike-author" id="reference-label">{{reference_label}}</p>

    <div class="context-sentences" style="display: none">
    {% if context_right %}
        <p><small>{{context_right|safe}}</small></p>
    {% endif %}
    </div>
</div>
</div>

<div class="row question-box">
    <div class="col-sm-12">
        <p class="priming-question">{{priming_question_text|safe}}</p>
    </div>
</div>

<input name="end_timestamp" type="hidden" value="" />
<input name="item_id" type="hidden" value="{{item_id}}" />
<input name="task_id" type="hidden" value="{{task_id}}" />
<input name="start_timestamp" type="hidden" value="" />
<input name="score" type="hidden" value="-1" />
{% if candidate2_text %}
<input name="score2" type="hidden" value="-1" />
{% endif %}

<div class="row quotelike">
    <div class="col-sm-12">
        <p class="candidate-text"><strong>{{candidate_text|safe}}</strong></p>
    </div>

    {% if scalar_slider %}
      {% with sliderid='' %}
      {% include 'EvalView/_scalar_slider.html' %}
      {% endwith %}
    {% elif sqm %}
      {% with sliderid='' %}
      {% include 'EvalView/_sqm_slider.html' %}
      {% endwith %}
    {% else %}
      {% with sliderid='' %}
      {% include 'EvalView/_slider.html' %}
      {% endwith %}
    {% endif %}

    {% if critical_error %}
    <div class="col-sm-12">
    <label class="">
      <div class="btn btn-warning button-critical-error" accesskey="6"
           title="Check this box if a translation error significantly changed the meaning of the candidate translation #1, for instance, an untranslated fragment, changed numerical value, surplus/omitted negation, repeated content, etc.">
        <input name="error1" type="checkbox" value="critical-semantic-error">
        Report serious translation error
      </div>
    </label>
    </div>
    {% endif %}
</div>

{% if candidate2_text %}

<div class="row quotelike">
    <div class="col-sm-12">
        <p class="candidate-text"><strong>{{candidate2_text|safe}}</strong></p>
    </div>
    {% if scalar_slider %}
      {% with sliderid='2' %}
      {% include 'EvalView/_scalar_slider.html' %}
      {% endwith %}
    {% elif sqm %}
      {% with sliderid='2' %}
      {% include 'EvalView/_sqm_slider.html' %}
      {% endwith %}
    {% else %}
      {% with sliderid='2' %}
      {% include 'EvalView/_slider.html' %}
      {% endwith %}
    {% endif %}

    {% if critical_error %}
    <div class="col-sm-12">
    <label class="">
      <div class="btn btn-warning button-critical-error" accesskey="6"
           title="Check this box if a translation error significantly changed the meaning of the candidate translation #2, for instance, an untranslated fragment, changed numerical value, surplus/omitted negation, repeated content, etc.">
        <input name="error2" type="checkbox" value="critical-semantic-error">
        Report serious translation error
      </div>
    </label>
    </div>
    {% endif %}
</div>
{% endif %}

<div class="actions">
  <table style="width:100%">
  <tr>
    <td style="width:50%;text-align:left;">
      <button onclick="javascript:reset_form();" accesskey="2" type="reset" class="btn"
              title="Reset the slider(s). Access key: '2'"><i class="icon-repeat"></i> Reset</button>

      {% if source_error %}
      <label class="">
        <div class="btn btn-danger"
             title="Check this box if a serious error appears in the source text making it difficult to understand or translate, for instance, it is not in {{source_language}}, contains multiple serious grammatical errors, is nonsense, etc.">
          <input name="source_error" type="checkbox" value="errors-in-source-text">
          Flag serious error(s) in the source text
        </div>
      </label>
      {% endif %}

      {% if candidate2_text %}
      <button onclick="javascript:toggle_diff();" accesskey="4" type="button" class="btn"
              title="Show or hide highlighted differences between segments. Access key: '4'">Show/Hide diff.</button>
      {% endif %}
      {% if context_left or context_right %}
      <button onclick="javascript:toggle_context();" accesskey="5" type="button" class="btn"
              title="Show or hide the context. Access key: '5'">Show/Hide context</button>
      {% endif %}
    </td>
    <td style="width:50%;text-align:right;">
      {% if candidate2_text and not scalar_slider %}
      <button onclick="javascript:match_sliders();" accesskey="3" type="button" class="btn"
              title="Match the second slider with the first one. Access key: '3'">Match sliders</button>
      {% endif %}
      <button class="btn btn-primary" name="submit_button" accesskey="1" type="submit" value="SUBMIT" onclick="javascript:return validate_form();"
              title="Submit score(s). Access key: '1'"><i class="icon-ok-sign icon-white"></i> Submit</button>
    </td>
  </tr>
  </table>
</div>

{% if scalar_slider %}
<br/>
<div class="question-box">
  {% with doclvl=doc_guidelines %}
  {% include 'EvalView/_scalar_instructions.html' %}
  {% endwith %}
</div>
{% elif sqm %}
<br/>
<div class="question-box">
  {% with doclvl=doc_guidelines %}
  {% include 'EvalView/_sqm_instructions.html' %}
  {% endwith %}
</div>
{% endif %}

{% if source_error %}
<br/>
<div class="row question-box">
  <div class="col-md-12">
    <b>Serious error(s) in the source text:</b> Please report if a serious error appears
    in the source text making it difficult to understand or translate, for
    instance, it is not in the expected language, contains multiple serious
    grammatical errors, is nonsense, etc.

    Report critical errors only; typos, minor grammatical errors, etc., that
    still make the text possible to understand and translate should not be
    reported.
  </div>
</div>
{% endif %}

{% if critical_error %}
<br/>
<div class="row">
  <div class="col-md-12">
    <b>Serious translation errors:</b> Please report if a translation error
    significantly changed the meaning of one of the candidate translations,
    for instance, an untranslated fragment, changed numerical value,
    surplus/omitted negation, repeated content, etc.

    Report critical translation errors only, minor errors should be reflected
    through the scores.
  </div>
</div>
{% endif %}

</form>

{% endblock %}
